<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>純前端 PDF 轉換器 (PDF Converter) by Yu-Han Cheng </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js: 渲染 PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- jsPDF: 產生 PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- JSZip: 用於批次下載壓縮 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Inter:wght@400;600;800&display=swap');
        
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
        }

        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            scroll-behavior: smooth;
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .tab-active { 
            background-color: var(--primary) !important;
            color: #ffffff !important; 
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2), 0 2px 4px -1px rgba(79, 70, 229, 0.1);
        }

        .drop-zone { 
            border: 2px dashed #e2e8f0; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        .drop-zone:hover, .drop-zone.dragover { 
            border-color: var(--primary); 
            background-color: #f5f3ff;
            transform: translateY(-2px);
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 28px;
            height: 28px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .preview-img { 
            width: 64px; 
            height: 64px; 
            object-fit: cover; 
            border-radius: 12px; 
            border: 1px solid #f1f5f9; 
            background-color: #fff;
        }

        .btn-primary {
            background-color: var(--primary);
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: scale(1.02);
        }

        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
        }

        .dragging {
            opacity: 0.5;
            background-color: #eef2ff;
            border: 2px dashed var(--primary);
        }
        
        .drag-over {
            border-top: 4px solid var(--primary) !important;
        }

        .sortable-item {
            cursor: grab;
            transition: transform 0.2s;
        }

        .sortable-item:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="bg-[#f8fafc] min-h-screen flex flex-col text-slate-800">

    <!-- 導覽列 -->
    <nav class="glass-nav sticky top-0 z-40 w-full">
        <div class="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="switchPage('main')">
                <div class="bg-indigo-600 p-1.5 rounded-lg text-white">
                    <i data-lucide="zap" class="w-5 h-5"></i>
                </div>
                <span class="text-xl font-extrabold tracking-tight text-slate-800">PDF Converter</span>
            </div>
            <div class="flex gap-6 text-sm font-semibold text-slate-600">
                <button onclick="switchPage('main')" class="hover:text-indigo-600 transition-colors">轉換工具</button>
                <button onclick="switchPage('about')" class="hover:text-indigo-600 transition-colors">關於本程式</button>
            </div>
        </div>
    </nav>

    <!-- 主要內容區 -->
    <main class="flex-grow">
        <div id="page-main" class="max-w-6xl mx-auto px-6 py-12">
            <header class="text-center mb-12">
                <h1 class="text-4xl font-extrabold text-slate-900 mb-3 tracking-tight text-slate-900">PDF 轉換小工具</h1>
                <p class="text-slate-500 max-w-2xl mx-auto">完全在瀏覽器中運行，不會將任何檔案上傳至伺服器，確保隱私保護。</p>
            </header>

            <!-- 功能頁籤 -->
            <div class="flex justify-center mb-10">
                <div class="bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200 flex gap-1">
                    <button onclick="switchTab('pdfToImg')" id="tab-pdfToImg" class="px-8 py-2.5 rounded-xl text-sm font-bold transition-all tab-active flex items-center gap-2">
                        <i data-lucide="image" class="w-4 h-4"></i> PDF 轉圖片
                    </button>
                    <button onclick="switchTab('imgToPdf')" id="tab-imgToPdf" class="px-8 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-400 hover:text-slate-600 flex items-center gap-2">
                        <i data-lucide="file-text" class="w-4 h-4"></i> 圖片轉 PDF
                    </button>
                </div>
            </div>

            <div id="statusMessage" class="hidden mb-6 p-4 rounded-xl text-sm text-center font-bold"></div>

            <!-- PDF 轉圖片 區塊 -->
            <section id="section-pdfToImg" class="block space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1">
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 card-shadow space-y-5">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2 border-b pb-3 text-sm">
                                <i data-lucide="sliders" class="w-4 h-4 text-indigo-500"></i> 轉換參數設定
                            </h3>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">輸出格式</label>
                                <select id="exportFormat" class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 text-slate-700">
                                    <option value="image/png">PNG</option>
                                    <option value="image/jpeg">JPG</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">解析度 (Scale)</label>
                                <select id="exportScale" class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 text-slate-700">
                                    <option value="1">1x (普通解析度)</option>
                                    <option value="2" selected>2x (高清 推薦)</option>
                                    <option value="3">3x (超清晰度)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="md:col-span-2 space-y-6">
                        <div id="drop-pdfToImg" class="drop-zone bg-white rounded-3xl p-16 text-center cursor-pointer card-shadow" onclick="document.getElementById('input-pdfToImg').click()">
                            <div class="flex flex-col items-center">
                                <div class="bg-indigo-50 text-indigo-600 p-4 rounded-full mb-4">
                                    <i data-lucide="upload-cloud" class="w-10 h-10"></i>
                                </div>
                                <p class="text-xl font-bold text-slate-800">上傳 PDF 檔案</p>
                                <p class="text-sm text-slate-400 mt-2">點擊此處或直接拖放檔案至區域內</p>
                            </div>
                            <input type="file" id="input-pdfToImg" class="hidden" accept="application/pdf">
                        </div>

                        <div id="p2i-results-container" class="hidden bg-white rounded-3xl p-8 shadow-sm border border-slate-200 space-y-8">
                            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 border-b border-slate-100 pb-6">
                                <div class="flex items-center gap-4">
                                    <div class="bg-green-100 text-green-600 p-3 rounded-2xl">
                                        <i data-lucide="check-check" class="w-6 h-6"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-slate-900 text-lg">轉換任務完成</h3>
                                        <p id="p2i-summary-text" class="text-sm text-slate-500 font-medium"></p>
                                    </div>
                                </div>
                                <button onclick="downloadAllAsZip()" class="btn-primary text-white px-8 py-3 rounded-2xl font-bold flex items-center gap-2 shadow-lg shadow-indigo-100 whitespace-nowrap">
                                    <i data-lucide="archive" class="w-5 h-5"></i> 批次下載 ZIP
                                </button>
                            </div>
                            
                            <div id="output-pdfToImg" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                                <!-- 預覽圖 -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 圖片/PDF 轉 PDF 區塊 -->
            <section id="section-imgToPdf" class="hidden space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 card-shadow space-y-5">
                            <h3 class="font-bold text-slate-800 border-b pb-3 flex items-center gap-2 text-sm">
                                <i data-lucide="settings-2" class="w-4 h-4 text-indigo-500"></i> PDF 輸出配置
                            </h3>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">頁面尺寸</label>
                                <select id="pdfPageSize" onchange="toggleOrientation()" class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 text-slate-700">
                                    <option value="original" selected>原始內容尺寸</option>
                                    <option value="a3">A3 規格</option>
                                    <option value="a4">A4 規格</option>
                                    <option value="a5">A5 規格</option>
                                    <option value="b3">B3 規格</option>
                                    <option value="b4">B4 規格</option>
                                    <option value="b5">B5 規格</option>
                                </select>
                            </div>
                            <div id="orientationContainer" class="hidden">
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">紙張方向</label>
                                <select id="pdfOrientation" class="w-full mt-1.5 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 text-slate-700">
                                    <option value="p">縱向 (Portrait)</option>
                                    <option value="l">橫向 (Landscape)</option>
                                </select>
                            </div>
                            <div class="pt-2 border-t space-y-4">
                                <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                                    <i data-lucide="info" class="w-4 h-4"></i> 文件資訊
                                </h4>
                                <div class="space-y-3">
                                    <input type="text" id="pdfTitle" placeholder="標題 (Title)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 text-slate-700">
                                    <input type="text" id="pdfAuthor" placeholder="作者 (Author)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 text-slate-700">
                                    <input type="text" id="pdfSubject" placeholder="主題 (Subject)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 text-slate-700">
                                    <input type="text" id="pdfKeywords" placeholder="關鍵字 (Keywords)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500 text-slate-700">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-3 space-y-6">
                        <div id="drop-imgToPdf" class="drop-zone bg-white rounded-3xl p-12 text-center cursor-pointer shadow-sm" onclick="document.getElementById('input-imgToPdf').click()">
                            <div class="flex flex-col items-center text-slate-800">
                                <div class="bg-indigo-50 text-indigo-600 p-4 rounded-full mb-4">
                                    <i data-lucide="plus" class="w-10 h-10"></i>
                                </div>
                                <p class="text-xl font-bold">選擇圖片或 PDF 檔案</p>
                                <p class="text-sm text-slate-400 mt-2">支援拖放多個檔案 (PDF 可點擊「展開」進行細節調整)</p>
                            </div>
                            <input type="file" id="input-imgToPdf" class="hidden" accept="image/*,application/pdf" multiple>
                        </div>

                        <div id="mixed-controls-header" class="hidden flex justify-between items-center px-4">
                            <h3 class="text-sm font-bold text-slate-500 flex items-center gap-2 tracking-wide uppercase"><i data-lucide="list-ordered" class="w-4 h-4 text-indigo-500"></i> 排程處理清單</h3>
                            <button onclick="clearMixedItems()" class="text-xs font-bold text-red-500 hover:text-red-700 flex items-center gap-1.5 transition-all bg-red-50 px-3 py-1.5 rounded-lg">
                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> 清空全部
                            </button>
                        </div>

                        <div id="mixed-list-preview" class="space-y-4">
                            <!-- 預覽清單 -->
                        </div>

                        <div id="action-imgToPdf" class="hidden flex flex-col items-center gap-6 bg-white p-8 rounded-3xl border border-slate-200 shadow-xl">
                            <div id="totalPageSummary" class="text-base font-bold text-slate-700 bg-slate-50 px-6 py-2 rounded-full border border-slate-100"></div>
                            <button onclick="convertMixedToPdf()" class="btn-primary w-full max-w-md text-white py-5 rounded-2xl font-black text-xl shadow-xl shadow-indigo-100 flex items-center justify-center gap-3 active:scale-95 transition-all">
                                <i data-lucide="check-circle" class="w-7 h-7"></i> 合成並下載 PDF
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- 關於頁面 -->
        <div id="page-about" class="hidden max-w-3xl mx-auto px-6 py-20">
            <div class="bg-white rounded-3xl p-10 card-shadow border border-slate-100 text-slate-700">
                <h2 class="text-3xl font-black text-slate-900 mb-8 flex items-center gap-3">
                    <i data-lucide="info" class="w-8 h-8 text-indigo-600"></i> 關於本程式
                </h2>
                
                <div class="space-y-8 leading-relaxed">
                    <section>
                        <h3 class="text-lg font-bold text-slate-800 mb-3 border-l-4 border-indigo-500 pl-4">開發人員資訊</h3>
                        <p class="mb-1"><strong>開發人員：</strong> 鄭郁翰 (Yu-Han Cheng)</p>
                        <p><strong>聯絡 Email：</strong> <a href="mailto:kaoshou@gmail.com" class="text-indigo-600 underline">kaoshou@gmail.com</a></p>
                    </section>

                    <section>
                        <h3 class="text-lg font-bold text-slate-800 mb-3 border-l-4 border-indigo-500 pl-4">程式開發動機</h3>
                        <p>本工具旨在提供一個安全且高效的 PDF 轉換解決方案。與常見的雲端服務不同，本程式採用 <strong>Client-side Processing (客戶端處理)</strong> 技術，您的私人文件絕不會上傳至任何遠端伺服器，所有運算都在您的本地瀏覽器中完成。</p>
                    </section>

                    <section>
                        <h3 class="text-lg font-bold text-slate-800 mb-3 border-l-4 border-indigo-500 pl-4">開放原始碼資訊</h3>
                        <p class="mb-4">本專案使用了多個開源套件來提供強大功能：</p>
                        <ul class="space-y-4">
                            <li class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <div class="font-bold text-slate-800">PDF.js</div>
                                <div class="text-xs text-slate-400 mt-1 mb-2">Developed by Mozilla - Apache License 2.0</div>
                                <div class="text-sm">負責 PDF 內容解析與 Canvas 高畫質渲染。</div>
                            </li>
                            <li class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <div class="font-bold text-slate-800">jsPDF</div>
                                <div class="text-xs text-slate-400 mt-1 mb-2">Developed by Parallax - MIT License</div>
                                <div class="text-sm">核心 PDF 文件生成與圖片嵌入邏輯。</div>
                            </li>
                            <li class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <div class="font-bold text-slate-800">JSZip</div>
                                <div class="text-xs text-slate-400 mt-1 mb-2">Developed by Stuk - MIT / GPLv3 License</div>
                                <div class="text-sm">提供強大的瀏覽器端檔案壓縮技術，用於批次下載。</div>
                            </li>
                            <li class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <div class="font-bold text-slate-800">Tailwind CSS & Lucide Icons</div>
                                <div class="text-xs text-slate-400 mt-1 mb-2">MIT / ISC License</div>
                                <div class="text-sm">建構現代化且響應式的 UI 視覺體驗與圖示。</div>
                            </li>
                        </ul>
                    </section>
                </div>

                <div class="mt-12 text-center">
                    <button onclick="switchPage('main')" class="text-indigo-600 font-bold flex items-center justify-center gap-2 mx-auto hover:gap-4 transition-all">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i> 回到轉換工具
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 頁尾 -->
    <footer class="bg-white border-t border-slate-200 py-10 mt-auto">
        <div class="max-w-6xl mx-auto px-6 text-center">
            <div class="flex flex-col items-center gap-4">                
                <p class="text-slate-400 text-sm">
                    &copy; 2025 Yu-Han Cheng. All Rights Reserved.
                </p>
                <div class="flex gap-4 text-xs font-bold text-slate-300">
                    <button onclick="switchPage('about')" class="hover:text-indigo-400 transition-colors">關於本程式</button>
                </div>
            </div>
        </div>
    </footer>

    <!-- 載入中遮罩 -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden flex items-center justify-center z-[999]">
        <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center">
            <div class="loader mb-4 scale-125"></div>
            <p class="text-slate-800 font-bold" id="loadingText">處理中...</p>
        </div>
    </div>

    <script>
        // 初始化 PDF.js Worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
        
        let mixedItems = [];
        let p2iGeneratedImages = [];
        let draggedItemIndex = null;

        // 初始化 Lucide 圖示
        lucide.createIcons();

        function switchPage(page) {
            const main = document.getElementById('page-main');
            const about = document.getElementById('page-about');
            if (page === 'main') {
                main.classList.remove('hidden');
                about.classList.add('hidden');
            } else {
                main.classList.add('hidden');
                about.classList.remove('hidden');
            }
            window.scrollTo(0, 0);
        }

        function switchTab(tab) {
            ['pdfToImg', 'imgToPdf'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const section = document.getElementById(`section-${t}`);
                section.classList.toggle('hidden', t !== tab);
                
                if (t === tab) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('text-slate-400');
                } else {
                    btn.classList.remove('tab-active');
                    btn.classList.add('text-slate-400');
                }
            });
            clearStatus();
        }

        function toggleOrientation() {
            const size = document.getElementById('pdfPageSize').value;
            const container = document.getElementById('orientationContainer');
            container.classList.toggle('hidden', size === 'original');
        }

        function showStatus(msg, type = 'info') {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = `mb-6 p-4 rounded-xl text-sm text-center ${type === 'error' ? 'bg-red-100 text-red-700 font-bold' : 'bg-indigo-100 text-indigo-700 font-bold'}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        function clearStatus() { document.getElementById('statusMessage').classList.add('hidden'); }

        function showLoading(show, text = '處理中...') {
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').textContent = text;
            show ? overlay.classList.remove('hidden') : overlay.classList.add('hidden');
        }

        // --- PDF 轉圖片功能 ---
        document.getElementById('input-pdfToImg').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            showLoading(true, '正在解析 PDF...');
            const format = document.getElementById('exportFormat').value;
            const scale = parseFloat(document.getElementById('exportScale').value);
            const output = document.getElementById('output-pdfToImg');
            const resultContainer = document.getElementById('p2i-results-container');
            const summaryText = document.getElementById('p2i-summary-text');
            
            output.innerHTML = '';
            p2iGeneratedImages = [];

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer.slice(0) }).promise;
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    showLoading(true, `正在轉換: ${i} / ${pdf.numPages}`);
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: scale });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = viewport.width; 
                    canvas.height = viewport.height;
                    
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    
                    const imgData = canvas.toDataURL(format, 0.9);
                    const ext = format === 'image/jpeg' ? 'jpg' : 'png';
                    p2iGeneratedImages.push({ data: imgData, name: `page_${i}.${ext}` });

                    const div = document.createElement('div');
                    div.className = "bg-white p-2 rounded-xl shadow-sm border border-slate-100 relative group overflow-hidden transition-all hover:border-indigo-200";
                    div.innerHTML = `
                        <img src="${imgData}" class="w-full h-auto rounded-lg">
                        <div class="absolute inset-0 bg-indigo-900/60 opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center">
                            <button onclick="downloadOne('${imgData}', 'p${i}')" class="bg-white p-2 rounded-full shadow-lg transform hover:scale-110 active:scale-90 transition-all"><i data-lucide="download" class="w-4 h-4 text-indigo-600"></i></button>
                        </div>
                        <div class="mt-2 text-[10px] text-center font-bold text-slate-400 uppercase tracking-widest">頁次 ${i}</div>
                    `;
                    output.appendChild(div);
                }
                summaryText.textContent = `來源檔案：${file.name} (共 ${pdf.numPages} 頁)`;
                resultContainer.classList.remove('hidden');
                lucide.createIcons();
                window.scrollTo({ top: resultContainer.offsetTop - 100, behavior: 'smooth' });
            } catch (err) { 
                console.error(err);
                showStatus('解析失敗：' + err.message, 'error'); 
            } finally { 
                showLoading(false); 
                e.target.value = ''; 
            }
        });

        function downloadOne(data, name) {
            const format = document.getElementById('exportFormat').value;
            const ext = format === 'image/jpeg' ? 'jpg' : 'png';
            const a = document.createElement('a'); 
            a.href = data; 
            a.download = `${name}.${ext}`; 
            a.click();
        }

        async function downloadAllAsZip() {
            if (!p2iGeneratedImages.length) return;
            showLoading(true, '正在打包壓縮檔案...');
            try {
                const zip = new JSZip();
                p2iGeneratedImages.forEach(img => zip.file(img.name, img.data.split(',')[1], { base64: true }));
                const content = await zip.generateAsync({ type: 'blob' });
                const a = document.createElement('a'); 
                a.href = URL.createObjectURL(content); 
                a.download = 'pdf_images_package.zip'; 
                a.click();
            } catch (err) {
                showStatus('ZIP 打包失敗', 'error');
            } finally {
                showLoading(false);
            }
        }

        // --- 圖片/PDF 轉 PDF 功能 ---
        document.getElementById('input-imgToPdf').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            showLoading(true, '正在讀取選取檔案...');
            
            try {
                for (const file of files) {
                    if (file.type === 'application/pdf') {
                        const buffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: buffer.slice(0) }).promise;
                        const page = await pdf.getPage(1);
                        const viewport = page.getViewport({ scale: 0.3 });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.width = viewport.width; 
                        canvas.height = viewport.height;
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        
                        mixedItems.push({ 
                            id: Math.random().toString(36).substr(2, 9), 
                            type: 'pdf', 
                            name: file.name, 
                            pages: pdf.numPages, 
                            data: buffer, 
                            preview: canvas.toDataURL() 
                        });
                    } else if (file.type.startsWith('image/')) {
                        const data = await new Promise(r => {
                            const reader = new FileReader();
                            reader.onload = re => r(re.target.result);
                            reader.readAsDataURL(file);
                        });
                        mixedItems.push({ 
                            id: Math.random().toString(36).substr(2, 9), 
                            type: 'image', 
                            name: file.name, 
                            pages: 1, 
                            data: data, 
                            preview: data 
                        });
                    }
                }
                renderMixedList();
            } catch (err) {
                showStatus('檔案讀取失敗', 'error');
            } finally {
                showLoading(false);
                e.target.value = '';
            }
        });

        // 渲染混合清單 (包含拖曳功能與展開按鈕)
        function renderMixedList() {
            const container = document.getElementById('mixed-list-preview');
            const summary = document.getElementById('totalPageSummary');
            const header = document.getElementById('mixed-controls-header');
            container.innerHTML = '';
            
            if (!mixedItems.length) { 
                document.getElementById('action-imgToPdf').classList.add('hidden'); 
                header.classList.add('hidden');
                return; 
            }
            
            document.getElementById('action-imgToPdf').classList.remove('hidden');
            header.classList.remove('hidden');
            
            let currentP = 1;
            mixedItems.forEach((item, idx) => {
                const range = item.pages > 1 ? `P.${currentP} ~ ${currentP + item.pages - 1}` : `P.${currentP}`;
                
                const div = document.createElement('div');
                div.className = "sortable-item flex items-center gap-4 bg-white p-4 rounded-2xl border border-slate-200 shadow-sm transition-all hover:shadow-md group relative";
                div.draggable = true;
                div.dataset.index = idx;

                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('dragleave', handleDragLeave);
                div.addEventListener('drop', handleDrop);
                div.addEventListener('dragend', handleDragEnd);

                // 是否顯示展開按鈕
                const expandBtn = (item.type === 'pdf' && item.pages > 1) 
                    ? `<button onclick="expandPdf(${idx}); event.stopPropagation();" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100 transition-colors flex items-center gap-1">
                        <i data-lucide="maximize-2" class="w-3.5 h-3.5"></i> 展開頁面
                       </button>` 
                    : "";

                div.innerHTML = `
                    <div class="flex items-center gap-3 flex-grow min-w-0">
                        <div class="text-slate-300 group-hover:text-indigo-400 cursor-move">
                             <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                        </div>
                        <img src="${item.preview}" class="preview-img">
                        <div class="flex-grow min-w-0">
                            <p class="text-sm font-bold truncate text-slate-800">${item.name}</p>
                            <p class="text-[10px] font-bold text-indigo-500 uppercase tracking-wider">順序：${range}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        ${expandBtn}
                        <div class="flex flex-col gap-1 text-slate-300 group-hover:text-slate-400">
                            <button title="向上移動" onclick="moveItem(${idx}, -1); event.stopPropagation();" class="p-1 hover:bg-slate-100 rounded-lg ${idx === 0 ? 'invisible' : ''}"><i data-lucide="chevron-up" class="w-4 h-4"></i></button>
                            <button title="向下移動" onclick="moveItem(${idx}, 1); event.stopPropagation();" class="p-1 hover:bg-slate-100 rounded-lg ${idx === mixedItems.length - 1 ? 'invisible' : ''}"><i data-lucide="chevron-down" class="w-4 h-4"></i></button>
                        </div>
                        <button title="移除" onclick="removeItem(${idx}); event.stopPropagation();" class="text-red-500 hover:bg-red-50 hover:text-red-600 p-2.5 rounded-xl transition-all"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                `;
                container.appendChild(div);
                currentP += item.pages;
            });
            summary.textContent = `待處理：${mixedItems.length} 個檔案 • 總計：${currentP - 1} 頁`;
            lucide.createIcons();
        }

        // --- 展開 PDF 功能 ---
        async function expandPdf(idx) {
            const item = mixedItems[idx];
            if (item.type !== 'pdf' || item.pages <= 1) return;

            showLoading(true, '正在展開 PDF 頁面...');
            
            try {
                const pdf = await pdfjsLib.getDocument({ data: item.data.slice(0) }).promise;
                const newItems = [];
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    showLoading(true, `正在解析第 ${i} 頁...`);
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 }); // 高清預覽
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = viewport.width; 
                    canvas.height = viewport.height;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    
                    const imgData = canvas.toDataURL('image/jpeg', 0.85);
                    
                    newItems.push({
                        id: Math.random().toString(36).substr(2, 9),
                        type: 'image', // 展開後視為獨立圖片處理
                        name: `${item.name} - P.${i}`,
                        pages: 1,
                        data: imgData,
                        preview: imgData
                    });
                }

                // 替換原本的項目
                mixedItems.splice(idx, 1, ...newItems);
                renderMixedList();
                showStatus(`已將「${item.name}」展開為 ${pdf.numPages} 個獨立頁面`);
            } catch (err) {
                console.error(err);
                showStatus('展開 PDF 失敗', 'error');
            } finally {
                showLoading(false);
            }
        }

        // --- 拖放邏輯 ---
        function handleDragStart(e) {
            draggedItemIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function handleDragOver(e) { e.preventDefault(); this.classList.add('drag-over'); }
        function handleDragLeave() { this.classList.remove('drag-over'); }
        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            const targetIndex = parseInt(this.dataset.index);
            if (draggedItemIndex !== null && draggedItemIndex !== targetIndex) {
                const itemToMove = mixedItems.splice(draggedItemIndex, 1)[0];
                mixedItems.splice(targetIndex, 0, itemToMove);
                renderMixedList();
            }
        }
        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('.sortable-item').forEach(item => item.classList.remove('drag-over'));
            draggedItemIndex = null;
        }

        function removeItem(idx) { mixedItems.splice(idx, 1); renderMixedList(); }
        function moveItem(idx, dir) { 
            const target = idx + dir;
            if (target < 0 || target >= mixedItems.length) return;
            [mixedItems[idx], mixedItems[target]] = [mixedItems[target], mixedItems[idx]]; 
            renderMixedList(); 
        }
        function clearMixedItems() { mixedItems = []; renderMixedList(); }

        // --- 合成 PDF 邏輯 ---
        async function convertMixedToPdf() {
            if (!mixedItems.length) return;
            showLoading(true, '合成作業啟動中...');
            
            const sizeMode = document.getElementById('pdfPageSize').value;
            const orientationSetting = document.getElementById('pdfOrientation').value;

            // 抓取建構函式
            const jspdfObj = window.jspdf;
            const jsPDF = jspdfObj ? jspdfObj.jsPDF : null;

            if (!jsPDF) {
                showStatus('合成失敗：無法載入 PDF 生成組件', 'error');
                showLoading(false);
                return;
            }

            try {
                let doc = null;
                let isFirst = true;

                for (const item of mixedItems) {
                    if (item.type === 'image') {
                        const img = new Image();
                        img.src = item.data;
                        await new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = reject;
                        });
                        
                        const imgW = img.naturalWidth;
                        const imgH = img.naturalHeight;
                        let pdfW, pdfH, orient;

                        if (sizeMode === 'original') {
                            pdfW = imgW; pdfH = imgH;
                            orient = pdfW > pdfH ? 'l' : 'p';
                        } else {
                            const tempDoc = new jsPDF({ unit: 'pt', format: sizeMode, orientation: orientationSetting });
                            pdfW = tempDoc.internal.pageSize.getWidth();
                            pdfH = tempDoc.internal.pageSize.getHeight();
                            orient = orientationSetting;
                        }

                        if (isFirst) {
                            doc = new jsPDF({ unit: 'pt', format: sizeMode === 'original' ? [pdfW, pdfH] : sizeMode, orientation: orient });
                            isFirst = false;
                        } else {
                            doc.addPage(sizeMode === 'original' ? [pdfW, pdfH] : sizeMode, orient);
                        }

                        if (sizeMode === 'original') {
                            doc.addImage(item.data, 'PNG', 0, 0, pdfW, pdfH);
                        } else {
                            const ratio = Math.min(pdfW / imgW, pdfH / imgH);
                            const drawW = imgW * ratio;
                            const drawH = imgH * ratio;
                            doc.addImage(item.data, 'PNG', (pdfW - drawW) / 2, (pdfH - drawH) / 2, drawW, drawH);
                        }
                    } else {
                        // PDF 類型處理
                        const sourcePdfData = await pdfjsLib.getDocument({ data: item.data.slice(0) }).promise;
                        for (let p = 1; p <= sourcePdfData.numPages; p++) {
                            const page = await sourcePdfData.getPage(p);
                            const viewportRender = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.width = viewportRender.width; 
                            canvas.height = viewportRender.height;
                            await page.render({ canvasContext: context, viewport: viewportRender }).promise;
                            
                            const imgData = canvas.toDataURL('image/jpeg', 0.95);
                            const origViewport = page.getViewport({ scale: 1.0 });
                            let pdfW, pdfH, orient;

                            if (sizeMode === 'original') {
                                pdfW = origViewport.width; pdfH = origViewport.height;
                                orient = pdfW > pdfH ? 'l' : 'p';
                            } else {
                                const tempDoc = new jsPDF({ unit: 'pt', format: sizeMode, orientation: orientationSetting });
                                pdfW = tempDoc.internal.pageSize.getWidth();
                                pdfH = tempDoc.internal.pageSize.getHeight();
                                orient = orientationSetting;
                            }

                            if (isFirst) {
                                doc = new jsPDF({ unit: 'pt', format: sizeMode === 'original' ? [pdfW, pdfH] : sizeMode, orientation: orient });
                                isFirst = false;
                            } else {
                                doc.addPage(sizeMode === 'original' ? [pdfW, pdfH] : sizeMode, orient);
                            }

                            if (sizeMode === 'original') {
                                doc.addImage(imgData, 'JPEG', 0, 0, pdfW, pdfH);
                            } else {
                                const ratio = Math.min(pdfW / origViewport.width, pdfH / origViewport.height);
                                const drawW = origViewport.width * ratio;
                                const drawH = origViewport.height * ratio;
                                doc.addImage(imgData, 'JPEG', (pdfW - drawW) / 2, (pdfH - drawH) / 2, drawW, drawH);
                            }
                        }
                    }
                }

                doc.setProperties({
                    title: document.getElementById('pdfTitle').value || "",
                    author: document.getElementById('pdfAuthor').value || "",
                    subject: document.getElementById('pdfSubject').value || "",
                    keywords: document.getElementById('pdfKeywords').value || ""
                });

                doc.save('result_document.pdf');
                showStatus('成功產出並下載 PDF！');
            } catch (err) { 
                console.error(err);
                showStatus('合成失敗：' + err.message, 'error'); 
            } finally { 
                showLoading(false); 
            }
        }

        // 拖放檔案上傳
        ['pdfToImg', 'imgToPdf'].forEach(id => {
            const zone = document.getElementById(`drop-${id}`);
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
            zone.addEventListener('drop', (e) => {
                e.preventDefault(); zone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    const inp = document.getElementById(`input-${id}`);
                    inp.files = e.dataTransfer.files;
                    inp.dispatchEvent(new Event('change'));
                }
            });
        });
    </script>
</body>
</html>